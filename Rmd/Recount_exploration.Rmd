---
title: "Recount exploration"
author: "Mustafa AbuElQumsan and Jacques van Helden"
output:
  html_document:
    code_folding: hide
    fig_caption: yes
    highlight: zenburn
    self_contained: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    fig_caption: yes
    highlight: zenburn
    toc: yes
    toc_depth: 3
  word_document: default
date: '`r Sys.Date()`'
editor_options: 
  chunk_output_type: console
---

```{r knitr_setup, include=FALSE,  eval=TRUE, echo=FALSE, warning=FALSE}
library(knitr)
knitr::opts_chunk$set(
  fig.path="figures/",
  echo=FALSE, 
  eval=TRUE, 
  cache=FALSE, 
  message=FALSE, 
  warning=FALSE)
library(recount)
library(SummarizedExperiment)
library(S4Vectors)
```


## General exploration of the metadata table

```{r summary_statistics_per_each_column_in_Rcount.metedata}
min.samples.per.class <- 10


recount.subsets <- c("sra", "gtex", "tcga") ## Supported values for recount subset attribute
recount.subset <- "sra" ## For the time being we work with SRA (Short Read Archive database)

recount.metadata.sra <- all_metadata(subset='sra')
recount.metadata.gtex <- all_metadata(subset='gtex')
recount.metadata.tgca <- all_metadata(subset='tcga')

recount.metadata <- recount.metadata.sra
# View(recount.metadata)
# View(as.data.frame(recount.metadata))
# names(recount.metadata)
dim(recount.metadata)

summary.per.col <- data.frame()
for (column in names(recount.metadata)) {
  
  col.stats <- data.frame(
    "column" = column,
    "unique.values" = length(unique(recount.metadata[, column]))
    )

    summary.per.col <- 
    rbind(summary.per.col, col.stats)
                            
}
summary.per.col

kable(summary.per.col)

```

# Exploration of characteristics

Each Recount entry (corresponding to a sequencing run for a given sample) can be described by one or more charcateristics (e.g. tissue, conditions, genotype, treatment, ...). This creates a problem when converting the metadata to a data frame with one column per field, since multi-value charcateristics cannot be automatically convereted to a value to be placed in a single column. 

```{r nb_characteristics_per_entry}
kable(as.data.frame.table(table(unlist(lapply(recount.metadata$characteristics, length)))), caption = "Number of values per entry for the characteristics attribute. ")

```

For the sake of summarization, we will concatenate the characteristics values in a single string per run, in order to view them in the metadata table (where there is a single row per run, and a single column for the field "characteristics"). 


```{r concatenate_characteristics}
## Concatenate characteristics in a single string per run
characteristics.string <- unlist(lapply(recount.metadata$characteristics, paste, collapse="; "))

## Back-conversion of "NA" strings (obtained from NA values) to NA values
characteristics.string[characteristics.string == "NA"] <- NA

## Count the number of NA or non-NA values for characteristics
table(is.na(characteristics.string))

## Cast metadata to a data frame with a single row per run
recount.metadata.frame <- as.data.frame(recount.metadata)
recount.metadata.frame$characteristics <- characteristics.string


## An example of dataset with multi-valued characteristics


## Return all projects havin a field named "disease status"
kable(as.data.frame.table(sort(table(recount.metadata.frame[grep(recount.metadata.frame$characteristics, pattern = "disease status: "), "project"]), decreasing = TRUE)), caption="Recount projects having 'disease status' as field name for the characteristics. ")
recount.metadata.frame.projects.disease.status<- unique(  sort(recount.metadata.frame[grep(recount.metadata.frame$characteristics, pattern = "disease status: "),"project"],decreasing = TRUE) )
length(recount.metadata.frame.projects.disease.status)


## select datasets with time in the characteristics (supposedly because the corresonding experiments are time series)
time.series <- as.data.frame.table(sort(table(recount.metadata.frame[grep(characteristics.string, pattern = "time: "), "project"]), decreasing = TRUE))

kable(time.series, caption="Recount projects corresponding to time series (the characteristics field contains 'time:'")

```


```{r counting_numbers_of_samples_for_each_disease_status_project} 

summary.of.project.disease <- data.frame()
for ( nb in 1:length(recount.metadata.frame.projects.disease.status)) {
sample.stat.of.disease.project <- data.frame(
  "project name" = recount.metadata.frame.projects.disease.status[nb],
  "samples of disease status" = (as.vector(unlist(subset(recount.metadata.frame, project == recount.metadata.frame.projects.disease.status[nb], select = "sample")))),
  "sample sums" = length((as.vector(unlist(subset(recount.metadata.frame, project == recount.metadata.frame.projects.disease.status[nb], select = "sample")))) )
  
) # end of data frame
summary.of.project.disease <- rbind(summary.of.project.disease, sample.stat.of.disease.project)
  }
unique.summary.of.project.disease <- lapply(summary.of.project.disease, unique) 
kable(unique.summary.of.project.disease)
summary.of.project.disease$sample.sums
```


```{r exploring_duplicating_in_row.name_for_project.disease}

recountID <- "SRP062966"
studyPath <- paste0("~/test_recount/",recountID)
dir.create(studyPath, recursive = TRUE, showWarnings = FALSE)
download_study(recountID, outdir = studyPath)
rse <- file.path(studyPath,"rse_gene.Rdata")
load(rse)
countTable <- assay(rse_gene)
runPheno <- colData(rse_gene)
length( row.names(runPheno))
length(unique(row.names(runPheno)))
View(as.data.frame(runPheno))
dim(countTable)
dim(runPheno)
row.names(runPheno) <- NULL



```




## Filtering out the NA values

```{r}
## Select the subset of metadata for which the field "characteristics" is defined
metadata.nona <- recount.metadata[!is.na(recount.metadata.frame$characteristics), ]
dim(metadata.nona)
message("Number of entries in recount.medatata is :", nrow(recount.metadata.frame))
message("Number of entries in metadata.nona is :", nrow(metadata.nona))

## count the number of projects with no NA value
nona.projects <- unique(metadata.nona$project)
message("Recount contains ", length (unique(recount.metadata$project)), " among which ", length(nona.projects), " projects have defined characteristics. These are the ones we can work with ")

## Count th number of distinct classes (characteristics) for each project
length(nona.projects)
View((nona.projects))
project <- "SRP008145"
x <- metadata.nona[project == nona.projects, ]
dim(x)
View(as.data.frame(x))

new.selected.project <- data.frame()
metadata.names <-names(metadata.nona)
if (is.null(nona.projects) || length(nona.projects) < 1) {
  message("There are no meta data for such project")
} else  {
  pro <- 1
  
  for (pro in 1:length(nona.projects)) {
     selected.project  <- metadata.nona$project[pro]
     new.project <- subset(metadata.nona, project == selected.project)
     new.project$sample.nb <- length(unique(new.project$sample))
     new.project$geo.acc.nb <- length(unique(na.omit(new.project$geo_accession)))
     new.project$characteristic.nb <- length(unique(new.project$characteristics))
     if( pro ==1 ){
       new.selected.project <- data.frame(new.project)
     } else {
       new.selected.project <- rbind(new.selected.project, new.project )
     } # end else 
  } # end for
}

new.selected.project<- asS4(new.selected.project)


## Select projects with at least 3 classes
x <- subset(new.selected.project,  new.selected.project$characteristic.nb > 3)

## Select projects with precisely 2 classes

## Select projects where there are at least 2 classes with the user-specified min number of samples (parameter previously defined)


View(as.data.frame(metadata.nona))

```


Recount contains `r length (unique(recount.metadata$project))` among which `r length(nona.projects)` projects have defined characteristics. 


## Exporation of a problematic dataset (with NA values in the characteristics column)



```{r}
library("IRanges")
## In the future, we wold like to understand why some GSE do work andother ones not
# abstract_search(recountID)
project_info <- abstract_search('GSE32465') ## This one works
# project_info <- abstract_search('GSE58135') ## Supposedly breast cancer
recountID <- project_info$project

## Select a Recount ID
recountID <- "SRP003611"
studyPath <- paste0("~/test_recount/",recountID)
dir.create(studyPath, recursive = TRUE, showWarnings = FALSE)
# dir.exists(studyPath)
# list.files(studyPath)


## TO DO for Mustaa: adapt the 2 lines bore in order to ensure that you get the right GSE for the recountID
selectedGSMs <- as.vector(unlist(subset(recount.metadata, project == recountID, select="geo_accession")))

## project_info <- abstract_search(selectedGSMs[1]) ## Does not work with GSM instead of GSE

## Download data from Recount
url <- download_study(recountID, outdir = studyPath)

## Load data
rseFile <- file.path(studyPath, "rse_gene.Rdata")
load(rseFile)
colData(rse_gene)
## hereafter are just the classes for each project
View(as.data.frame(rse_gene@colData@listData$characteristics@unlistData))
length(rse_gene@colData@listData$characteristics@unlistData)
row.names(unique(rse_gene@colData))
colnames(rse_gene)
View(as.data.frame(rse_gene))

# to retrieve the raw count Table
# View(assay(rse_gene))


# explore the pheno Table
rse_gene[, rse_gene$characteristics@elementMetadata]
rse_gene$characteristics@metadata
rse_gene$characteristics@partitioning
rse_gene$characteristics@unlistData
rse_gene$characteristics@elementType


names(colData(rse_gene))
find_geo()
x <-sapply(colData(rse_gene)$run[1:2], find_geo)
View(as.data.frame(x))
length(unique( colData(rse_gene)$project))
length(unique(colData(rse_gene)$experiment))
length( unique(colData(rse_gene)$run))
table( unique( colData(rse_gene)$characteristics))
Na.characteristics <- sum( is.na(colData(rse_gene)$characteristics))

# To explor which regions we are interest 
rowData(rse_gene)
rowRanges(rse_gene)

# Experiment-wide metadata
metadata(rse_gene)

# How to subsetting the SE
rse_gene[1:5 , 1:4]
rse_gene[, rse_gene$characteristics != "NA"]


## put the code to extract the pheno table from this dataset, and explore it!Are there several interesting columns tere ? 

## Count samples for this project
selected.project.metadata <- subset(recount.metadata, project == recountID)
dim(selected.project.metadata)
sample.nb <- length(unique(selected.project.metadata$sample))
geo.acc.nb <- length(unique(na.omit(selected.project.metadata$geo_accession)))
characteristic.nb <- length(unique(selected.project.metadata$characteristics))
message(sample.nb, " samples, ", geo.acc.nb, " non-NA geo accession numbers, ", "classes Number:", characteristic.nb  )

```


